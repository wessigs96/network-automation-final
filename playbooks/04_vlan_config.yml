# Define VLAN list at top level so both plays can access it
- name: VLAN and trunk configuration on switch
  hosts: cisco-switches
  gather_facts: no
  become: yes
  vars:
    vlan_list:
      - { id: 20, name: Management, native: true }
      - { id: 30, name: Data }
      - { id: 40, name: Voice }
    trunk_ports:
      - FastEthernet0/1
      - FastEthernet0/2
  tasks:
    # ...existing tasks...

- name: VLAN subinterface configuration on routers
  hosts: cisco-routers
  gather_facts: no
  become: yes
  vars:
    vlan_list:
      - { id: 20, name: Management, native: true }
      - { id: 30, name: Data }
      - { id: 40, name: Voice }
    router_subinterface_ips: {}
  tasks:
    - name: Configure subinterfaces on router GigabitEthernet0/0/0 for each VLAN
      ios_config:
        lines:
          - "interface GigabitEthernet0/0/0.{{ item.id }}"
          - "{{ 'encapsulation dot1Q ' ~ item.id ~ ' native' if item.native | default(false) else 'encapsulation dot1Q ' ~ item.id }}"
          - "{{ 'ip address ' ~ (router_subinterface_ips[inventory_hostname][item.id] ) if (router_subinterface_ips is defined and router_subinterface_ips.get(inventory_hostname) is defined and router_subinterface_ips[inventory_hostname].get(item.id) is defined) else '' }}"
        skip_empty_lines: true
      loop: "{{ vlan_list }}"
      loop_control:
        label: "GigabitEthernet0/0/0.{{ item.id }}"