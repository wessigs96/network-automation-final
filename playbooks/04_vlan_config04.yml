---
# ============================================================
# 04B - ROAS + VLANs/Trunks (Ansible 2.9 safe)
# Fixes:
#  - Configure switch VLANs/trunks FIRST (so VLAN tagging exists)
#  - Use ios_config parents for subinterfaces (no big Jinja block)
#  - Increase command timeout to reduce "hang" from slow CLI
# ============================================================

- name: 04B - Configure VLANs + trunks on switch first
  hosts: cisco-switches
  gather_facts: no

  vars:
    vlans_to_create:
      - { id: 20, name: Management }
      - { id: 30, name: Data }
      - { id: 40, name: Voice }

    trunk_ports:
      - FastEthernet0/1
      - FastEthernet0/2

  tasks:
    - name: Create VLANs 20, 30, 40
      ios_config:
        parents: "vlan {{ item.id }}"
        lines:
          - "name {{ item.name }}"
      loop: "{{ vlans_to_create }}"

    - name: Configure trunk ports to routers (native VLAN 1)
      ios_config:
        parents: "interface {{ item }}"
        lines:
          - switchport mode trunk
          - switchport trunk native vlan 1
          - switchport trunk allowed vlan 1,20,30,40
      loop: "{{ trunk_ports }}"

    - name: Verify VLANs and trunks
      ios_command:
        commands:
          - show vlan brief
          - show interfaces trunk
      register: sw_verify

    - debug:
        msg: |
          ===== {{ inventory_hostname }} ({{ ansible_host }}) - show vlan brief =====
          {{ sw_verify.stdout[0] }}

          ===== {{ inventory_hostname }} ({{ ansible_host }}) - show interfaces trunk =====
          {{ sw_verify.stdout[1] }}


- name: 04B - Configure ROAS subinterfaces on routers second
  hosts: cisco-routers
  gather_facts: no

  vars:
    router_parent_int: GigabitEthernet0/0/0

    router_subifs:
      router1:
        - { vlan: 20, ip: "10.0.12.1", mask: "255.255.255.0" }
      router2:
        - { vlan: 20, ip: "10.0.12.2", mask: "255.255.255.0" }

  tasks:
    - name: Ensure parent interface is up
      ios_config:
        parents: "interface {{ router_parent_int }}"
        lines:
          - no shut

    - name: Configure each ROAS subinterface using parents (stable)
      ios_config:
        parents: "interface {{ router_parent_int }}.{{ item.vlan }}"
        lines:
          - "encapsulation dot1Q {{ item.vlan }}"
          - "ip address {{ item.ip }} {{ item.mask }}"
          - no shut
      loop: "{{ router_subifs[inventory_hostname] }}"

    - name: Verify router subinterfaces
      ios_command:
        commands:
          - show ip interface brief | include {{ router_parent_int }}
      register: rtr_ints

    - debug:
        msg: |
          ===== {{ inventory_hostname }} ({{ ansible_host }}) - Interfaces =====
          {{ rtr_ints.stdout[0] }}
